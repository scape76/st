<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Progress Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .form-section, .list-section {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
        }
        h1, h2, h3 {
            color: #333;
        }
        label {
            display: block;
            margin-top: 10px;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .task-list, .subject-list {
            list-style-type: none;
            padding: 0;
        }
        .task-item, .subject-item {
            background-color: #f9f9f9;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 4px;
        }
        .task-item:hover, .subject-item:hover {
            background-color: #f0f0f0;
        }
        .task-title {
            font-weight: bold;
        }
        .task-deadline {
            color: #e74c3c;
        }
        .task-completed {
            background-color: #d5f5d5;
        }
        .loading {
            text-align: center;
            margin: 20px;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Academic Progress Tracker</h1>
    <div id="loading" class="loading">Loading WebAssembly module...</div>
    
    <div id="app" style="display: none;">
        <div class="container">
            <!-- Subject Management -->
            <div class="form-section">
                <h2>Subject Management</h2>
                <form id="subject-form">
                    <label for="subject-name">Subject Name:</label>
                    <input type="text" id="subject-name" required>
                    
                    <label for="subject-code">Subject Code:</label>
                    <input type="text" id="subject-code" required>
                    
                    <label for="subject-description">Description:</label>
                    <textarea id="subject-description" rows="3"></textarea>
                    
                    <button type="submit">Create Subject</button>
                </form>
            </div>
            
            <!-- Task Management -->
            <div class="form-section">
                <h2>Task Management</h2>
                <form id="task-form">
                    <label for="task-subject">Subject:</label>
                    <select id="task-subject" required>
                        <option value="">-- Select Subject --</option>
                    </select>
                    
                    <label for="task-title">Task Title:</label>
                    <input type="text" id="task-title" required>
                    
                    <label for="task-description">Description:</label>
                    <textarea id="task-description" rows="3"></textarea>
                    
                    <label for="task-deadline">Deadline:</label>
                    <input type="datetime-local" id="task-deadline" required>
                    
                    <label for="task-type">Type:</label>
                    <select id="task-type" required>
                        <option value="1">Lab</option>
                        <option value="2">Project</option>
                        <option value="3">Exam</option>
                    </select>
                    
                    <button type="submit">Create Task</button>
                </form>
            </div>
        </div>
        
        <div class="container" style="margin-top: 20px;">
            <!-- Subject List -->
            <div class="list-section">
                <h2>Subjects</h2>
                <ul id="subject-list" class="subject-list">
                    <!-- Subjects will be added here -->
                </ul>
            </div>
            
            <!-- Task List -->
            <div class="list-section">
                <h2>Tasks</h2>
                <select id="task-filter-subject">
                    <option value="">-- All Subjects --</option>
                </select>
                <ul id="task-list" class="task-list">
                    <!-- Tasks will be added here -->
                </ul>
            </div>
        </div>
        
        <!-- Task Completion Modal -->
        <div id="complete-task-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div style="background-color: white; margin: 100px auto; padding: 20px; width: 300px; border-radius: 5px;">
                <h3>Mark Task as Completed</h3>
                <form id="complete-task-form">
                    <input type="hidden" id="complete-task-subject-index">
                    <input type="hidden" id="complete-task-index">
                    
                    <label for="complete-task-marks">Marks (0-100):</label>
                    <input type="number" id="complete-task-marks" min="0" max="100" required>
                    
                    <div id="grade-display" style="margin-top: 10px;"></div>
                    
                    <div style="margin-top: 15px;">
                        <button type="submit">Submit</button>
                        <button type="button" onclick="document.getElementById('complete-task-modal').style.display = 'none'">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script type="text/javascript">
        // Load the WebAssembly module
        let Module;
        let subjectIndex = 0;
        
        async function loadModule() {
            try {
                // Import the WebAssembly module
                Module = await import('./academic_tracker.js');
                const AcademicTracker = await Module.default();
                
                // Hide loading and show app
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                // Initialize the application
                AcademicTracker.initApp();
                
                // Setup event listeners
                setupEventListeners(AcademicTracker);
                
                // Load initial data
                loadSubjects(AcademicTracker);
            } catch (error) {
                console.error('Failed to load WebAssembly module:', error);
                document.getElementById('loading').textContent = 'Error loading module: ' + error.message;
            }
        }
        
        function setupEventListeners(AcademicTracker) {
            // Subject form submission
            document.getElementById('subject-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('subject-name').value;
                const code = document.getElementById('subject-code').value;
                const description = document.getElementById('subject-description').value;
                
                const index = AcademicTracker.createSubject(name, code, description);
                
                if (index >= 0) {
                    alert('Subject created successfully!');
                    loadSubjects(AcademicTracker);
                    this.reset();
                } else {
                    alert('Failed to create subject.');
                }
            });
            
            // Task form submission
            document.getElementById('task-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const subjectIndex = document.getElementById('task-subject').value;
                const title = document.getElementById('task-title').value;
                const description = document.getElementById('task-description').value;
                const deadline = document.getElementById('task-deadline').value.replace('T', ' ') + ':00';
                const taskType = document.getElementById('task-type').value;
                
                const index = AcademicTracker.createTask(
                    parseInt(subjectIndex), 
                    title, 
                    description, 
                    deadline, 
                    parseInt(taskType)
                );
                
                if (index >= 0) {
                    alert('Task created successfully!');
                    loadTasks(AcademicTracker, subjectIndex);
                    this.reset();
                    document.getElementById('task-subject').value = subjectIndex;
                } else {
                    alert('Failed to create task.');
                }
            });
            
            // Task filter
            document.getElementById('task-filter-subject').addEventListener('change', function() {
                loadTasks(AcademicTracker, this.value);
            });
            
            // Complete task form
            document.getElementById('complete-task-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const subjectIndex = document.getElementById('complete-task-subject-index').value;
                const taskIndex = document.getElementById('complete-task-index').value;
                const marks = document.getElementById('complete-task-marks').value;
                
                const success = AcademicTracker.markTaskAsCompleted(
                    parseInt(subjectIndex),
                    parseInt(taskIndex),
                    parseInt(marks)
                );
                
                if (success) {
                    alert('Task marked as completed!');
                    document.getElementById('complete-task-modal').style.display = 'none';
                    loadTasks(AcademicTracker, document.getElementById('task-filter-subject').value);
                } else {
                    alert('Failed to mark task as completed.');
                }
            });
            
            // Show grade when marks change
            document.getElementById('complete-task-marks').addEventListener('input', function() {
                const marks = parseInt(this.value);
                if (marks >= 0 && marks <= 100) {
                    const grade = AcademicTracker.getGradeForMarks(marks);
                    document.getElementById('grade-display').textContent = `Grade: ${grade}`;
                } else {
                    document.getElementById('grade-display').textContent = '';
                }
            });
        }
        
        function loadSubjects(AcademicTracker) {
            const subjects = AcademicTracker.getAllSubjects();
            
            // Update subject list
            const subjectList = document.getElementById('subject-list');
            subjectList.innerHTML = '';
            
            // Update subject dropdowns
            const taskSubjectSelect = document.getElementById('task-subject');
            const filterSubjectSelect = document.getElementById('task-filter-subject');
            
            taskSubjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
            filterSubjectSelect.innerHTML = '<option value="">-- All Subjects --</option>';
            
            for (let i = 0; i < subjects.size(); i++) {
                const subject = subjects.get(i);
                
                // Add to subject list
                const li = document.createElement('li');
                li.className = 'subject-item';
                li.innerHTML = `
                    <strong>${subject.name} (${subject.code})</strong>
                    <p>${subject.description}</p>
                    <p>Tasks: ${subject.tasks ? subject.tasks.size() : 0}</p>
                `;
                subjectList.appendChild(li);
                
                // Add to subject dropdowns
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${subject.name} (${subject.code})`;
                taskSubjectSelect.appendChild(option.cloneNode(true));
                filterSubjectSelect.appendChild(option);
            }
        }
        
        function loadTasks(AcademicTracker, selectedSubjectIndex) {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            
            if (selectedSubjectIndex === '') {
                // Load tasks for all subjects
                const subjects = AcademicTracker.getAllSubjects();
                
                for (let i = 0; i < subjects.size(); i++) {
                    const subject = subjects.get(i);
                    const tasks = AcademicTracker.getTasksForSubject(i);
                    
                    if (tasks.size() > 0) {
                        // Add subject header
                        const header = document.createElement('h3');
                        header.textContent = subject.name;
                        taskList.appendChild(header);
                        
                        // Add tasks
                        addTasksToList(AcademicTracker, tasks, i, taskList);
                    }
                }
            } else {
                // Load tasks for selected subject
                const tasks = AcademicTracker.getTasksForSubject(parseInt(selectedSubjectIndex));
                addTasksToList(AcademicTracker, tasks, parseInt(selectedSubjectIndex), taskList);
            }
        }
        
        function addTasksToList(AcademicTracker, tasks, subjectIndex, taskList) {
            for (let j = 0; j < tasks.size(); j++) {
                const task = tasks.get(j);
                
                const li = document.createElement('li');
                li.className = `task-item ${task.completed ? 'task-completed' : ''}`;
                
                // Format deadline
                const deadlineDate = new Date(task.deadline);
                const formattedDeadline = deadlineDate.toLocaleString();
                
                li.innerHTML = `
                    <div class="task-title">${task.title} (${task.type})</div>
                    <div class="task-deadline">Due: ${formattedDeadline}</div>
                    <p>${task.description}</p>
                    <div>Status: ${task.stateName}</div>
                `;
                
                if (task.completed) {
                    li.innerHTML += `<div>Marks: ${task.marks} - Grade: ${AcademicTracker.getGradeForMarks(task.marks)}</div>`;
                } else {
                    // Add complete button
                    const completeBtn = document.createElement('button');
                    completeBtn.textContent = 'Mark as Completed';
                    completeBtn.addEventListener('click', function() {
                        // Show the modal
                        document.getElementById('complete-task-subject-index').value = subjectIndex;
                        document.getElementById('complete-task-index').value = j;
                        document.getElementById('complete-task-marks').value = '';
                        document.getElementById('grade-display').textContent = '';
                        document.getElementById('complete-task-modal').style.display = 'block';
                    });
                    li.appendChild(completeBtn);
                }
                
                taskList.appendChild(li);
            }
        }
        
        // Load the module when the page loads
        window.onload = loadModule;
    </script>
</body>
</html>